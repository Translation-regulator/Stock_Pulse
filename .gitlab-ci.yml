stages:
  - build
  - deploy

default:
  image: docker:latest
  services:
    - docker:dind

# Build FastAPI
build-fastapi:
  stage: build
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - backend/app/**/*

  script:
    - docker build -t stockpulse-api ./backend/app

# Build Crawler
build-crawler:
  stage: build
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - backend/crawler/**/*

  script:
    - docker build -t stockpulse-crawler ./backend/crawler

# Deploy Backend on EC2
deploy-backend:
  stage: deploy
  tags:
    - ec2
  needs: [build-fastapi, build-crawler]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - backend/**/*

  script:
    - echo "ä½¿ç”¨ EC2 Runner ç›´æ¥éƒ¨ç½²å¾Œç«¯"

    # ç”¢ç”Ÿ FastAPI ç”¨çš„ .env
    - |
      cat <<EOF > ./backend/app/.env
      DB_HOST=$DB_HOST
      DB_USER=$DB_USER
      DB_PASSWORD=$DB_PASSWORD
      DB_NAME=$DB_NAME
      FUGLE_API_TOKEN=$FUGLE_API_TOKEN
      SECRET_KEY=$SECRET_KEY
      ALGORITHM=$ALGORITHM
      ACCESS_TOKEN_EXPIRE_MINUTES=$ACCESS_TOKEN_EXPIRE_MINUTES
      EOF

    - docker stop fastapi-app || true
    - docker rm fastapi-app || true
    - docker build -t stockpulse-api ./backend/app
    - docker run -d --name fastapi-app -p 8000:8000 --env-file ./backend/app/.env stockpulse-api

    - docker build -t stockpulse-crawler ./backend/crawler

    - echo "å¾Œç«¯éƒ¨ç½²å®Œæˆ"


# å»ºç½®å‰ç«¯
build-frontend:
  stage: build
  image: node:18
  script:
    - cd frontend
    - npm install
    - npm run build
    - echo "æ‰“åŒ…çµæœï¼š"
    - ls -R dist
  artifacts:
    paths:
      - frontend/dist
    expire_in: 1 hour  # ä¿è­‰ä½ èƒ½åœ¨ GitLab UI ä¸Šçœ‹åˆ°ä¸‹è¼‰æŒ‰éˆ•
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - frontend/src/**/*
        - frontend/vite.config.js
        - frontend/package*.json
        - .gitlab-ci.yml

# éƒ¨ç½²å‰ç«¯åˆ° AWS
deploy-frontend:
  stage: deploy
  image: amazon/aws-cli:2.15.33 # ä½¿ç”¨ AWS CLI å®˜æ–¹æ˜ åƒæª”ï¼Œç‰ˆæœ¬å›ºå®šè¼ƒå¥½ç®¡ç†
  needs: [build-frontend] # ç¢ºä¿åœ¨å‰ç«¯å»ºç½®æˆåŠŸå¾Œæ‰åŸ·è¡Œæ­¤æ­¥é©Ÿ
  script:
    - echo "--- ç¢ºèªç’°å¢ƒè®Šæ•¸å…§å®¹ ---"
    - echo "S3_BUCKET: $AWS_S3_BUCKET"
    - echo "REGION: $AWS_DEFAULT_REGION"
    - echo "CLOUDFRONT_ID: $AWS_CLOUDFRONT_ID"
    # æª¢æŸ¥å¿…è¦è®Šæ•¸æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœè®Šæ•¸ç‚ºç©ºï¼Œå‰‡ç›´æ¥é€€å‡º
    - |
      if [ -z "$AWS_S3_BUCKET" ] || [ -z "$AWS_DEFAULT_REGION" ] || [ -z "$AWS_CLOUDFRONT_ID" ]; then
        echo "âŒ å¿…è¦çš„ AWS ç’°å¢ƒè®Šæ•¸æœªè¨­å®šï¼"
        exit 1
      fi

    - echo "--- é©—è­‰ AWS èº«ä»½ ---"
    # ä½¿ç”¨ set -e ç¢ºä¿å‘½ä»¤å¤±æ•—æ™‚ç«‹å³é€€å‡ºï¼Œç°¡åŒ–éŒ¯èª¤è™•ç†
    # 'aws sts get-caller-identity' ç”¨æ–¼ç¢ºèª AWS credentials æ˜¯å¦æœ‰æ•ˆ
    - aws sts get-caller-identity || { echo "âŒ AWS èªè­‰å¤±æ•—ï¼è«‹æª¢æŸ¥ AWS_ACCESS_KEY_ID å’Œ AWS_SECRET_ACCESS_KEYã€‚"; exit 1; }

    - echo "--- æª¢æŸ¥å‰ç«¯å»ºç½®ç”¢ç‰© frontend/dist ---"
    # æª¢æŸ¥ frontend/dist ç›®éŒ„æ˜¯å¦å­˜åœ¨ä¸”éç©º
    - |
      if [ ! -d "frontend/dist" ] || [ -z "$(ls -A frontend/dist)" ]; then
        echo "âŒ å»ºç½®ç”¢ç‰© frontend/dist ä¸å­˜åœ¨æˆ–ç‚ºç©ºï¼è«‹ç¢ºèª build-frontend æ­¥é©Ÿæ˜¯å¦æˆåŠŸã€‚"
        exit 1
      fi
    - echo "frontend/dist ç›®éŒ„å­˜åœ¨ä¸”åŒ…å«æª”æ¡ˆã€‚"

    - echo "--- ä¸Šå‚³è‡³ S3 ($AWS_S3_BUCKET) ---"
    # ä½¿ç”¨ --acl public-read ç¢ºä¿éœæ…‹ç¶²ç«™å¯è¨ªå•
    # ä½¿ç”¨ --cache-control é©ç•¶è¨­å®šç€è¦½å™¨å¿«å–ç­–ç•¥ï¼Œæå‡æ•ˆèƒ½
    - aws s3 sync frontend/dist/ s3://$AWS_S3_BUCKET \
      --region $AWS_DEFAULT_REGION \
      --delete \
      --acl public-read \
      --cache-control "max-age=300" || { echo "âŒ S3 ä¸Šå‚³å¤±æ•—ï¼è«‹æª¢æŸ¥å„²å­˜æ¡¶åç¨±å’Œæ¬Šé™ã€‚"; exit 1; }
    - echo "âœ… S3 ä¸Šå‚³å®Œæˆã€‚"

    - echo "--- æ¸…é™¤ CloudFront å¿«å– ($AWS_CLOUDFRONT_ID) ---"
    # æ¸…é™¤æ‰€æœ‰è·¯å¾‘çš„å¿«å–ï¼Œç¢ºä¿æœ€æ–°å…§å®¹è¢«åˆ†ç™¼
    - aws cloudfront create-invalidation --distribution-id $AWS_CLOUDFRONT_ID --paths "/*" || { echo "âŒ CloudFront å¿«å–æ¸…é™¤å¤±æ•—ï¼è«‹æª¢æŸ¥ CloudFront åˆ†é… IDã€‚"; exit 1; }
    - echo "âœ… CloudFront å¿«å–æ¸…é™¤å®Œæˆã€‚"

    - echo "--- å‰ç«¯éƒ¨ç½²å®Œæˆï¼ğŸš€ ---"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"' # åªåœ¨ main åˆ†æ”¯çš„æ¨é€æˆ–åˆä½µæ™‚è§¸ç™¼éƒ¨ç½²






