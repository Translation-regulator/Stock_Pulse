stages:
  - build
  - deploy

default:
  image: docker:latest
  services:
    - docker:dind

# Build FastAPI
build-fastapi:
  stage: build
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - docker build -t stockpulse-api ./backend/app

# Build Crawler
build-crawler:
  stage: build
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - docker build -t stockpulse-crawler ./backend/crawler

# Build Frontend (Vue)
build-frontend:
  stage: build
  image: node:18
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - cd frontend
    - npm install
    - npm run build

# Deploy Backend on EC2
deploy-backend:
  stage: deploy
  tags:
    - ec2   # ä½¿ç”¨ EC2 Runner
  needs: [build-fastapi, build-crawler]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - echo "ä½¿ç”¨ EC2 Runner ç›´æ¥éƒ¨ç½²å¾Œç«¯"

    # ç”¢ç”Ÿ FastAPI ç”¨çš„ .env
    - |
      cat <<EOF > ./backend/app/.env
      DB_HOST=$DB_HOST
      DB_USER=$DB_USER
      DB_PASSWORD=$DB_PASSWORD
      DB_NAME=$DB_NAME
      FUGLE_API_TOKEN=$FUGLE_API_TOKEN
      SECRET_KEY=$SECRET_KEY
      ALGORITHM=$ALGORITHM
      ACCESS_TOKEN_EXPIRE_MINUTES=$ACCESS_TOKEN_EXPIRE_MINUTES
      EOF

    # é‡å»º FastAPI å®¹å™¨
    - docker stop fastapi-app || true
    - docker rm fastapi-app || true
    - docker build -t stockpulse-api ./backend/app
    - docker run -d --name fastapi-app -p 8000:8000 --env-file ./backend/app/.env stockpulse-api

    # Crawler imageï¼ˆåƒ…å»ºç½®ä¸åŸ·è¡Œï¼‰
    - docker build -t stockpulse-crawler ./backend/crawler

    - echo "å¾Œç«¯éƒ¨ç½²å®Œæˆ"

# Deploy Frontend to S3 + CloudFront
deploy-frontend:
  stage: deploy
  image: node:18
  needs: [build-frontend]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - cd frontend

    # é©—è­‰ç’°å¢ƒè®Šæ•¸æ˜¯å¦å­˜åœ¨
    - >
      MISSING_VAR=0; 
      for var in AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_DEFAULT_REGION AWS_S3_BUCKET AWS_CLOUDFRONT_ID; do
        if [ -z "${!var}" ]; then
          echo "âŒ ç’°å¢ƒè®Šæ•¸ $var æœªè¨­å®š";
          MISSING_VAR=1;
        fi;
      done;
      if [ "$MISSING_VAR" -eq 1 ]; then
        echo "ğŸ›‘ åœæ­¢éƒ¨ç½²ï¼Œè«‹è£œé½Šä¸Šæ–¹ç¼ºå°‘çš„è®Šæ•¸";
        exit 1;
      fi

    # å®‰è£ AWS CLI
    - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
    - unzip awscliv2.zip
    - sudo ./aws/install

    # éƒ¨ç½²åˆ° S3
    - aws s3 sync dist/ s3://$AWS_S3_BUCKET --region $AWS_DEFAULT_REGION --delete

    # CloudFront å¿«å–å¤±æ•ˆ
    - aws cloudfront create-invalidation --distribution-id $AWS_CLOUDFRONT_ID --paths "/*"

    - echo "å‰ç«¯éƒ¨ç½²å®Œæˆï¼"
