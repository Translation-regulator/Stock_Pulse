stages:
  - build
  - deploy

default:
  image: docker:latest
  services:
    - docker:dind

# Build FastAPI
build-fastapi:
  stage: build
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - backend/app/**/*

  script:
    - docker build -t stockpulse-api ./backend/app

# Build Crawler
build-crawler:
  stage: build
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - backend/crawler/**/*

  script:
    - docker build -t stockpulse-crawler ./backend/crawler

# Deploy Backend on EC2
deploy-backend:
  stage: deploy
  tags:
    - ec2
  needs: [build-fastapi, build-crawler]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - backend/**/*

  script:
    - echo "ä½¿ç”¨ EC2 Runner ç›´æ¥éƒ¨ç½²å¾Œç«¯"

    # ç”¢ç”Ÿ FastAPI ç”¨çš„ .env
    - |
      cat <<EOF > ./backend/app/.env
      DB_HOST=$DB_HOST
      DB_USER=$DB_USER
      DB_PASSWORD=$DB_PASSWORD
      DB_NAME=$DB_NAME
      FUGLE_API_TOKEN=$FUGLE_API_TOKEN
      SECRET_KEY=$SECRET_KEY
      ALGORITHM=$ALGORITHM
      ACCESS_TOKEN_EXPIRE_MINUTES=$ACCESS_TOKEN_EXPIRE_MINUTES
      EOF

    - docker stop fastapi-app || true
    - docker rm fastapi-app || true
    - docker build -t stockpulse-api ./backend/app
    - docker run -d --name fastapi-app -p 8000:8000 --env-file ./backend/app/.env stockpulse-api

    - docker build -t stockpulse-crawler ./backend/crawler

    - echo "å¾Œç«¯éƒ¨ç½²å®Œæˆ"


# å»ºç½®å‰ç«¯
build-frontend:
  stage: build
  image: node:18
  script:
    - cd frontend
    - npm install
    - npm run build
    - echo "æ‰“åŒ…çµæœï¼š"
    - ls -R dist
  artifacts:
    paths:
      - frontend/dist
    expire_in: 1 hour  # ä¿è­‰ä½ èƒ½åœ¨ GitLab UI ä¸Šçœ‹åˆ°ä¸‹è¼‰æŒ‰éˆ•
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - frontend/src/**/*
        - frontend/vite.config.js
        - frontend/package*.json
        - .gitlab-ci.yml

deploy-frontend:
  stage: deploy
  image: amazon/aws-cli:2.15.33
  needs: [build-frontend]
  script:
    - echo "ç¢ºèªç’°å¢ƒè®Šæ•¸å…§å®¹"
    - echo "S3_BUCKET = $AWS_S3_BUCKET"
    - echo "REGION    = $AWS_DEFAULT_REGION"
    - echo "CLOUDFRONT_ID = $AWS_CLOUDFRONT_ID"

    - echo "ğŸ” æª¢æŸ¥ AWS ç›¸é—œè®Šæ•¸æ˜¯å¦æ­£ç¢º"
    - |
      for var in AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_DEFAULT_REGION AWS_S3_BUCKET AWS_CLOUDFRONT_ID; do
        if [ -z "${!var}" ]; then
          echo "âŒ ç¼ºå°‘ç’°å¢ƒè®Šæ•¸ï¼š$var"
          exit 1
        fi
      done

    - echo "é©—è­‰ AWS èº«ä»½"
    - aws sts get-caller-identity || (echo "AWS èªè­‰å¤±æ•—" && exit 1)

    - echo "æª¢æŸ¥ frontend/dist æ˜¯å¦å­˜åœ¨"
    - ls -al frontend/dist || (echo "dist ä¸å­˜åœ¨" && exit 1)

    - echo "ä¸Šå‚³è‡³ S3..."
    - echo "åŸ·è¡ŒæŒ‡ä»¤: aws s3 sync frontend/dist/ s3://$AWS_S3_BUCKET --region $AWS_DEFAULT_REGION --delete"
    - aws s3 sync frontend/dist/ s3://$AWS_S3_BUCKET --region $AWS_DEFAULT_REGION --delete || (echo "âŒ S3 ä¸Šå‚³å¤±æ•—" && exit 1)

    - echo "CloudFront å¿«å–æ¸…é™¤..."
    - aws cloudfront create-invalidation --distribution-id $AWS_CLOUDFRONT_ID --paths "/*" || (echo "âŒ CloudFront æ¸…é™¤å¤±æ•—" && exit 1)

    - echo "ğŸ‰ éƒ¨ç½²å®Œæˆ"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'









